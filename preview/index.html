<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawPunks — All NFTs from Contract</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: #1a1a2e;
      color: #eee;
      margin: 0;
      padding: 1.5rem;
      min-height: 100vh;
    }
    h1 { margin: 0 0 0.5rem; font-size: 1.25rem; }
    .subtitle { font-size: 0.85rem; color: #888; margin-bottom: 1rem; }
    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-bottom: 1.5rem;
    }
    .control-group {
      flex: 0 0 auto;
    }
    .control-group label {
      display: block;
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 0.25rem;
    }
    .control-group input {
      padding: 0.5rem 0.75rem;
      background: #0f0f1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #eee;
      font-family: monospace;
      font-size: 0.85rem;
      min-width: 320px;
    }
    .control-group input:focus {
      outline: none;
      border-color: #2196f3;
    }
    button {
      padding: 0.6rem 1.2rem;
      background: #2196f3;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover { background: #1976d2; }
    button:disabled { background: #444; cursor: not-allowed; color: #888; }
    .status { font-size: 0.85rem; color: #888; margin-bottom: 1rem; }
    .error { color: #f44336; font-size: 0.85rem; margin-top: 0.5rem; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.75rem;
      align-items: start;
    }
    .nft-card {
      background: #16213e;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: transform 0.15s;
    }
    .nft-card:hover { transform: scale(1.03); }
    .nft-card img {
      display: block;
      width: 100%;
      aspect-ratio: 1;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .nft-card .label {
      padding: 0.4rem 0.5rem;
      font-size: 0.75rem;
      color: #aaa;
      text-align: center;
    }
    .nft-card .desc {
      padding: 0 0.5rem 0.35rem;
      font-size: 0.7rem;
      color: #888;
      line-height: 1.3;
    }
    .nft-card .attrs {
      padding: 0 0.5rem 0.5rem;
      font-size: 0.68rem;
      color: #999;
    }
    .nft-card .attrs span {
      display: block;
      margin-bottom: 0.15rem;
    }
    .placeholder-card {
      background: #0f0f1a;
      border-radius: 8px;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #444;
      font-size: 0.8rem;
    }
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .pagination button {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
    .pagination .page-info {
      font-size: 0.85rem;
      color: #888;
      padding: 0 0.5rem;
    }
    .pagination select {
      padding: 0.4rem 0.6rem;
      background: #0f0f1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #eee;
      font-size: 0.85rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ClawPunks — First Free NFT Airdrop To Agents Only</h1>

  <div id="status" class="status">Loading…</div>
  <div id="error" class="error"></div>
  <div id="pagination" class="pagination" style="display: none;">
    <span class="page-info">Per page:</span>
    <select id="perPage">
      <option value="10">10</option>
      <option value="50">50</option>
      <option value="100" selected>100</option>
      <option value="200">200</option>
    </select>
  </div>
  <div id="grid" class="grid"></div>

  <script>
    const MAX_SUPPLY = 844;

    const ERC721_ABI = ["function tokenURI(uint256 tokenId) view returns (string)"];

    let config = { contractAddress: null, rpcUrl: null };
    let contract = null;
    let totalMinted = 0;
    let currentPage = 1;
    let nftCache = {}; // tokenId -> { tokenId, data }

    function getPerPage() {
      const sel = document.getElementById("perPage");
      return sel ? parseInt(sel.value, 10) : 100;
    }

    async function ensureConfig() {
      if (config.contractAddress && config.rpcUrl) return config;
      const res = await fetch("/api/config");
      if (!res.ok) throw new Error("Failed to load config");
      config = await res.json();
      return config;
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    function setError(msg) {
      document.getElementById("error").textContent = msg || "";
    }

    async function findTotalMinted(c) {
      let lo = 0, hi = MAX_SUPPLY;
      while (lo < hi) {
        const mid = (lo + hi + 1) >> 1;
        try {
          await c.tokenURI(mid);
          lo = mid;
        } catch {
          hi = mid - 1;
        }
      }
      return lo + 1;
    }

    function renderCard(tokenId, data) {
      const card = document.createElement("div");
      card.className = "nft-card";
      const img = document.createElement("img");
      img.src = data.image;
      img.alt = data.name || `ClawPunk #${tokenId}`;
      img.loading = "lazy";
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = data.name || `#${tokenId}`;
      card.appendChild(img);
      card.appendChild(label);
      if (data.description) {
        const desc = document.createElement("div");
        desc.className = "desc";
        desc.textContent = data.description;
        card.appendChild(desc);
      }
      if (data.attributes && data.attributes.length > 0) {
        const attrs = document.createElement("div");
        attrs.className = "attrs";
        data.attributes.forEach(a => {
          const span = document.createElement("span");
          span.textContent = `${a.trait_type}: ${a.value}`;
          attrs.appendChild(span);
        });
        card.appendChild(attrs);
      }
      return card;
    }

    function renderPagination() {
      const perPage = getPerPage();
      const totalPages = Math.ceil(totalMinted / perPage);
      const pagination = document.getElementById("pagination");
      const perPageSelect = document.getElementById("perPage");
      if (perPageSelect && !perPageSelect.onchange) {
        perPageSelect.onchange = () => {
          currentPage = 1;
          goToPage(1);
        };
      }
      pagination.style.display = "flex";
      while (pagination.children.length > 2) pagination.removeChild(pagination.lastChild);
      if (totalPages > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Prev";
        prevBtn.disabled = currentPage <= 1;
        prevBtn.onclick = () => goToPage(currentPage - 1);
        pagination.appendChild(prevBtn);
        const info = document.createElement("span");
        info.className = "page-info";
        info.textContent = `Page ${currentPage} of ${totalPages}`;
        pagination.appendChild(info);
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage >= totalPages;
        nextBtn.onclick = () => goToPage(currentPage + 1);
        pagination.appendChild(nextBtn);
      }
    }

    function renderGrid(tokenIds) {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      for (const id of tokenIds) {
        const cached = nftCache[id];
        if (cached && cached.data.image) {
          grid.appendChild(renderCard(id, cached.data));
        }
      }
    }

    async function goToPage(page) {
      const perPage = getPerPage();
      const totalPages = Math.ceil(totalMinted / perPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      const start = (page - 1) * perPage;
      const end = Math.min(start + perPage, totalMinted);
      const tokenIds = Array.from({ length: end - start }, (_, i) => start + i);
      const toFetch = tokenIds.filter(id => !nftCache[id]);
      const totalToLoad = toFetch.length;
      if (toFetch.length > 0) {
        const BATCH = 10;
        for (let i = 0; i < toFetch.length; i += BATCH) {
          const batch = toFetch.slice(i, i + BATCH);
          const results = await Promise.allSettled(
            batch.map(id => contract.tokenURI(id).then(uri => ({ tokenId: id, uri })))
          );
          results.forEach((r) => {
            if (r.status === "fulfilled" && r.value.uri) {
              const { tokenId, uri } = r.value;
              if (uri.startsWith("data:application/json;base64,")) {
                const data = JSON.parse(atob(uri.slice("data:application/json;base64,".length)));
                nftCache[tokenId] = { tokenId, data };
              }
            }
          });
          const loaded = Math.min(i + BATCH, totalToLoad);
          setStatus(`Loading NFTs… ${loaded}/${totalToLoad} of page ${page}`);
          renderGrid(tokenIds);
        }
      }
      renderGrid(tokenIds);
      setStatus(`Page ${page} (${start + 1}–${end} of ${totalMinted})`);
      renderPagination();
    }

    async function loadAllNFTs() {
      const grid = document.getElementById("grid");
      const pagination = document.getElementById("pagination");

      setError("");
      grid.innerHTML = "";
      pagination.style.display = "none";

      try {
        setStatus("Loading config…");
        const { contractAddress, rpcUrl } = await ensureConfig();
        setStatus("Connecting…");
        const provider = new ethers.JsonRpcProvider(rpcUrl);
        contract = new ethers.Contract(contractAddress, ERC721_ABI, provider);

        setStatus("Finding total minted…");
        totalMinted = await findTotalMinted(contract);
        if (totalMinted === 0) {
          setStatus("No NFTs minted yet.");
          return;
        }

        nftCache = {};
        currentPage = 1;
        pagination.style.display = "flex";
        await goToPage(1);
      } catch (err) {
        setError(err.message || "Failed to load NFTs");
        setStatus("");
      }
    }

    document.addEventListener("DOMContentLoaded", loadAllNFTs);
  </script>
</body>
</html>
