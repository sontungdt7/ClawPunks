<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawPunks — All NFTs from Contract</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: #1a1a2e;
      color: #eee;
      margin: 0;
      padding: 1.5rem;
      min-height: 100vh;
    }
    h1 { margin: 0 0 0.5rem; font-size: 1.25rem; }
    .subtitle { font-size: 0.85rem; color: #888; margin-bottom: 1rem; }
    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-bottom: 1.5rem;
    }
    .control-group {
      flex: 0 0 auto;
    }
    .control-group label {
      display: block;
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 0.25rem;
    }
    .control-group input {
      padding: 0.5rem 0.75rem;
      background: #0f0f1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #eee;
      font-family: monospace;
      font-size: 0.85rem;
      min-width: 320px;
    }
    .control-group input:focus {
      outline: none;
      border-color: #2196f3;
    }
    button {
      padding: 0.6rem 1.2rem;
      background: #2196f3;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover { background: #1976d2; }
    button:disabled { background: #444; cursor: not-allowed; color: #888; }
    .status { font-size: 0.85rem; color: #888; margin-bottom: 1rem; }
    .error { color: #f44336; font-size: 0.85rem; margin-top: 0.5rem; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.75rem;
      align-items: start;
    }
    .nft-card {
      background: #16213e;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: transform 0.15s;
    }
    .nft-card:hover { transform: scale(1.03); }
    .nft-card img {
      display: block;
      width: 100%;
      aspect-ratio: 1;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .nft-card .label {
      padding: 0.4rem 0.5rem;
      font-size: 0.75rem;
      color: #aaa;
      text-align: center;
    }
    .nft-card .desc {
      padding: 0 0.5rem 0.35rem;
      font-size: 0.7rem;
      color: #888;
      line-height: 1.3;
    }
    .nft-card .attrs {
      padding: 0 0.5rem 0.5rem;
      font-size: 0.68rem;
      color: #999;
    }
    .nft-card .attrs span {
      display: block;
      margin-bottom: 0.15rem;
    }
    .placeholder-card {
      background: #0f0f1a;
      border-radius: 8px;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #444;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <h1>ClawPunks — All NFTs from Contract</h1>
  <p class="subtitle">Load and display all minted NFTs. No token ID needed.</p>

  <div class="controls">
    <div class="control-group">
      <label>Contract Address</label>
      <input type="text" id="contractAddress" placeholder="0xd99aDFa07f97C444DCDddAA70B3c58A9d33124EE" />
    </div>
    <div class="control-group">
      <label>RPC URL (Sepolia)</label>
      <input type="text" id="rpcUrl" placeholder="https://rpc.sepolia.org" />
    </div>
    <div class="control-group">
      <button id="loadBtn" onclick="loadAllNFTs()">Load All NFTs</button>
    </div>
  </div>
  <div id="status" class="status"></div>
  <div id="error" class="error"></div>
  <div id="grid" class="grid"></div>

  <script>
    const DEFAULT_CONTRACT = "0xd99aDFa07f97C444DCDddAA70B3c58A9d33124EE";
    const DEFAULT_RPC = "https://rpc.sepolia.org";
    const MAX_SUPPLY = 10000;

    const ERC721_ABI = ["function tokenURI(uint256 tokenId) view returns (string)"];

    function getContractAddress() {
      const v = document.getElementById("contractAddress").value.trim();
      return v || DEFAULT_CONTRACT;
    }

    function getRpcUrl() {
      const v = document.getElementById("rpcUrl").value.trim();
      return v || DEFAULT_RPC;
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    function setError(msg) {
      document.getElementById("error").textContent = msg || "";
    }

    async function findTotalMinted(contract) {
      let lo = 0, hi = MAX_SUPPLY;
      while (lo < hi) {
        const mid = (lo + hi + 1) >> 1;
        try {
          await contract.tokenURI(mid);
          lo = mid;
        } catch {
          hi = mid - 1;
        }
      }
      return lo + 1;
    }

    async function loadAllNFTs() {
      const btn = document.getElementById("loadBtn");
      const grid = document.getElementById("grid");

      setError("");
      btn.disabled = true;
      grid.innerHTML = "";

      try {
        setStatus("Connecting…");
        const provider = new ethers.JsonRpcProvider(getRpcUrl());
        const contract = new ethers.Contract(getContractAddress(), ERC721_ABI, provider);

        setStatus("Finding total minted…");
        const totalMinted = await findTotalMinted(contract);
        if (totalMinted === 0) {
          setStatus("No NFTs minted yet.");
          return;
        }

        setStatus(`Loading ${totalMinted} NFTs…`);
        const results = await Promise.allSettled(
          Array.from({ length: totalMinted }, (_, i) =>
            contract.tokenURI(i).then(uri => ({ tokenId: i, uri }))
          )
        );

        const nfts = results
          .filter(r => r.status === "fulfilled")
          .map(r => r.value);

        setStatus(`Showing ${nfts.length} NFTs`);

        for (const { tokenId, uri } of nfts) {
          if (!uri || !uri.startsWith("data:application/json;base64,")) continue;
          const base64Json = uri.slice("data:application/json;base64,".length);
          const data = JSON.parse(atob(base64Json));
          if (!data.image) continue;

          const card = document.createElement("div");
          card.className = "nft-card";
          const img = document.createElement("img");
          img.src = data.image;
          img.alt = data.name || `ClawPunk #${tokenId}`;
          img.loading = "lazy";
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = data.name || `#${tokenId}`;
          card.appendChild(img);
          card.appendChild(label);

          if (data.description) {
            const desc = document.createElement("div");
            desc.className = "desc";
            desc.textContent = data.description;
            card.appendChild(desc);
          }

          if (data.attributes && data.attributes.length > 0) {
            const attrs = document.createElement("div");
            attrs.className = "attrs";
            data.attributes.forEach(a => {
              const span = document.createElement("span");
              span.textContent = `${a.trait_type}: ${a.value}`;
              attrs.appendChild(span);
            });
            card.appendChild(attrs);
          }

          grid.appendChild(card);
        }
      } catch (err) {
        setError(err.message || "Failed to load NFTs");
        setStatus("");
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
